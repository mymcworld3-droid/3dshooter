var AutoDestroy=pc.createScript("autoDestroy");AutoDestroy.attributes.add("lifetime",{type:"number",default:3}),AutoDestroy.prototype.initialize=function(){this.timer=0},AutoDestroy.prototype.update=function(t){this.timer+=t,this.timer>=this.lifetime&&this.entity.destroy()};var DualTouchController=pc.createScript("dualTouchController");DualTouchController.attributes.add("bulletSpeed",{type:"number",default:30}),DualTouchController.attributes.add("fireRate",{type:"number",default:.2}),DualTouchController.attributes.add("serverUrl",{type:"string",default:"http://localhost:3000"}),DualTouchController.prototype.initialize=function(){var t=this;this.joystickBase=this.entity.findByName("JoystickBase"),this.joystickThumb=this.entity.findByName("JoystickThumb"),this.joystickBase.enabled=!1,this.joystickThumb.enabled=!1,this.joystickTouchId=null,this.joystickCenter=new pc.Vec2,this.joystickDirection=new pc.Vec2,this.joystickRadius=80,this.camera=this.entity.findByName("Camera"),this.lookTouchId=null,this.lastLookX=0,this.lastLookY=0,this.pitch=0,this.lookSpeed=.25,this.torqueFactor=5,this.fixedY=this.entity.getPosition().y,this.fireButton=this.app.root.findByName("FireButton"),this.isFiring=!1,this.fireTimer=0,this.socket=io.connect(this.serverUrl),this.players={},this.socket.on("initPlayers",(function(i){i.forEach((i=>{i.id!==t.socket.id&&t.spawnPlayer(i.id,i.position,i.rotation)}))})),this.socket.on("playerJoined",(function(i){i.id!==t.socket.id&&t.spawnPlayer(i.id,[0,0,0],[0,0,0])})),this.socket.on("playerLeft",(function(i){t.players[i.id]&&(t.players[i.id].destroy(),delete t.players[i.id])})),this.socket.on("updatePlayer",(function(i){t.players[i.id]&&(t.players[i.id].setPosition(new pc.Vec3(...i.position)),t.players[i.id].setEulerAngles(new pc.Vec3(...i.rotation)))})),this.socket.on("spawnBullet",(function(i){t.spawnBullet(i.id,i.position,i.rotation)})),this.fireButton&&(this.fireButton.button.on("mousedown",this.startFire,this),this.fireButton.button.on("touchstart",this.startFire,this),this.fireButton.button.on("mouseup",this.stopFire,this),this.fireButton.button.on("touchend",this.stopFire,this)),this.app.touch.on(pc.EVENT_TOUCHSTART,this.onTouchStart,this),this.app.touch.on(pc.EVENT_TOUCHMOVE,this.onTouchMove,this),this.app.touch.on(pc.EVENT_TOUCHEND,this.onTouchEnd,this),this.entity.rigidbody&&(this.entity.rigidbody.angularFactor=new pc.Vec3(0,1,0))},DualTouchController.prototype.isLeftSide=function(t){return t<.25*this.app.graphicsDevice.width},DualTouchController.prototype.isRightSide=function(t){return t>=.25*this.app.graphicsDevice.width},DualTouchController.prototype.onTouchStart=function(t){for(var i=0;i<t.touches.length;i++){var o=t.touches[i];this.isLeftSide(o.x)&&null===this.joystickTouchId?(this.joystickTouchId=o.id,this.joystickCenter.set(o.x,o.y),this.joystickBase.enabled=!0,this.joystickThumb.enabled=!0,this.joystickBase.setLocalPosition(o.x-640,360-o.y,0),this.joystickThumb.setLocalPosition(o.x-640,360-o.y,1)):this.isRightSide(o.x)&&null===this.lookTouchId&&(this.lookTouchId=o.id,this.lastLookX=o.x,this.lastLookY=o.y)}},DualTouchController.prototype.onTouchMove=function(t){for(var i=0;i<t.touches.length;i++){var o=t.touches[i];if(o.id===this.joystickTouchId){var e=o.x-this.joystickCenter.x,s=o.y-this.joystickCenter.y,h=new pc.Vec2(e,s);h.length()>this.joystickRadius&&h.normalize().scale(this.joystickRadius),this.joystickDirection.set(h.x/this.joystickRadius,-h.y/this.joystickRadius),this.joystickThumb.setLocalPosition(this.joystickCenter.x+h.x-640,-this.joystickCenter.y-h.y+360,1)}if(o.id===this.lookTouchId&&this.entity.rigidbody){e=o.x-this.lastLookX,s=o.y-this.lastLookY;var n=new pc.Vec3(0,-e*this.lookSpeed*this.torqueFactor,0);this.entity.rigidbody.applyTorque(n),this.pitch+=-s*this.lookSpeed,this.pitch=pc.math.clamp(this.pitch,-80,80),this.camera.setLocalEulerAngles(this.pitch,0,0),this.lastLookX=o.x,this.lastLookY=o.y}}},DualTouchController.prototype.onTouchEnd=function(t){for(var i=0;i<t.changedTouches.length;i++){var o=t.changedTouches[i];o.id===this.joystickTouchId&&(this.joystickTouchId=null,this.joystickDirection.set(0,0),this.joystickBase.enabled=!1,this.joystickThumb.enabled=!1),o.id===this.lookTouchId&&(this.lookTouchId=null)}},DualTouchController.prototype.startFire=function(){this.isFiring=!0},DualTouchController.prototype.stopFire=function(){this.isFiring=!1,this.fireTimer=0},DualTouchController.prototype.shootBullet=function(){var t=this.camera.getPosition().clone().add(this.camera.forward.clone().scale(1.5)),i=this.camera.getEulerAngles().clone();this.socket.emit("shoot",{position:[t.x,t.y,t.z],rotation:[i.x,i.y,i.z]}),this.spawnBullet("local",[t.x,t.y,t.z],[i.x,i.y,i.z])},DualTouchController.prototype.spawnPlayer=function(t,i,o){var e=this.app.root.findByName("PlayerTemplate");if(e){var s=e.clone();s.enabled=!0,s.setPosition(new pc.Vec3(...i)),s.setEulerAngles(new pc.Vec3(...o)),this.app.root.addChild(s),this.players[t]=s}},DualTouchController.prototype.spawnBullet=function(t,i,o){var e=this.app.root.findByName("BulletTemplate");if(e){var s=e.clone();s.enabled=!0,s.setPosition(new pc.Vec3(...i)),s.setRotation((new pc.Quat).setFromEulerAngles(...o)),this.app.root.addChild(s),s.rigidbody&&s.rigidbody.applyImpulse(s.forward.clone().scale(this.bulletSpeed)),s.script.create("autoDestroy",{attributes:{lifetime:3}})}},DualTouchController.prototype.update=function(t){if(this.joystickDirection.length()>0&&this.entity.rigidbody){var i=new pc.Vec3(this.joystickDirection.x,0,this.joystickDirection.y),o=this.entity.forward.clone();o.y=0,o.normalize();var e=this.entity.right.clone();e.y=0,e.normalize(),i=o.scale(i.z).add(e.scale(i.x)),this.entity.rigidbody.applyForce(i.scale(10))}var s=this.entity.getPosition();if(s.y=this.fixedY,this.entity.setPosition(s),this.socket.emit("playerState",{position:[s.x,s.y,s.z],rotation:[this.entity.getEulerAngles().x,this.entity.getEulerAngles().y,this.entity.getEulerAngles().z],direction:[this.joystickDirection.x,this.joystickDirection.y]}),this.isFiring)for(this.fireTimer+=t;this.fireTimer>=this.fireRate;)this.fireTimer-=this.fireRate,this.shootBullet()};